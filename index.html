<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EdgeOS Bootloader</title>

<style>
:root{
  --bg:#0b1020;
  --panel:rgba(25,30,50,.95);
  --panel2:rgba(255,255,255,.08);
  --text:#fff;
  --accent:#2563eb;
  --good:#22c55e;
  --bad:#ef4444;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;}
#wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;}
.card{
  width:min(720px, 94vw);
  background:var(--panel);
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  padding:18px;
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
h1{margin:0 0 6px 0;font-size:26px;}
small{opacity:.8;}
hr{border:none;border-top:1px solid rgba(255,255,255,.12);margin:14px 0;}
button{
  background:var(--accent); color:#fff; border:none; border-radius:10px;
  padding:10px 14px; cursor:pointer; font-size:14px;
}
button.secondary{background:rgba(255,255,255,.14);}
button.danger{background:var(--bad);}
button:disabled{opacity:.55;cursor:default;}
input[type="file"]{color:#fff;}
#status{opacity:.9;white-space:pre-wrap;line-height:1.35;}
.progress{height:10px;border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden;flex:1;min-width:200px;}
.bar{height:100%;width:0%;background:var(--good);transition:width .25s;}
#debug{display:none;background:rgba(0,0,0,.28);border-radius:12px;padding:10px;margin-top:10px;}
#debug pre{margin:0;max-height:220px;overflow:auto;font-size:12px;white-space:pre-wrap;}
#app{min-height:100vh;}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.12);font-size:12px;opacity:.9;}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<div id="app"></div>

<div id="wrap">
  <div class="card" id="bootCard">
    <div class="row" style="justify-content:space-between;">
      <div>
        <h1>EdgeOS</h1>
        <small id="sub">Bootloader / Installer</small>
      </div>
      <div class="tag" id="verTag">No system installed</div>
    </div>

    <p id="status">Checking installation…</p>

    <div class="row" style="margin-top:8px;">
      <div class="progress"><div class="bar" id="bar"></div></div>
      <button class="secondary" id="forceBtn" onclick="showInstaller()">Force Installer</button>
    </div>

    <hr>

    <!-- INSTALLER -->
    <div id="installer">
      <div class="row">
        <input type="file" id="zipInput" accept=".zip" />
        <button onclick="installFromZip()">Install / Update</button>
        <button class="secondary" onclick="bootIfInstalled()">Boot</button>
        <button class="danger" onclick="powerwashInstaller()">Powerwash</button>
      </div>
      <small class="small" style="display:block;margin-top:8px;opacity:.8;">
        ZIP must contain app.html, app.js, style.css (foldered ZIPs are supported).
      </small>

      <div id="debug">
        <strong>ZIP contents</strong>
        <pre id="debugList"></pre>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const K_HTML = "edgeos_app_html";
const K_JS   = "edgeos_app_js";
const K_CSS  = "edgeos_app_css";
const K_VER  = "edgeos_version";

/* =========================
   UI REFS
========================= */
const statusEl = document.getElementById("status");
const barEl = document.getElementById("bar");
const verTag = document.getElementById("verTag");
const debugBox = document.getElementById("debug");
const debugList = document.getElementById("debugList");

/* =========================
   HELPERS
========================= */
function setBar(p){ barEl.style.width = Math.max(0, Math.min(100, p)) + "%"; }

function hasInstalledOS(){
  return !!(localStorage.getItem(K_HTML) && localStorage.getItem(K_JS) && localStorage.getItem(K_CSS));
}

function showInstaller(){
  // installer is always present; just update message
  const v = localStorage.getItem(K_VER);
  verTag.textContent = v ? ("Installed: " + v) : "No system installed";
  statusEl.textContent = v
    ? "Installer ready. You can update EdgeOS with a ZIP package."
    : "No EdgeOS installation found. Please install from ZIP.";
  setBar(0);
}

/* =========================
   BOOT
========================= */
function bootIfInstalled(){
  if(!hasInstalledOS()){
    showInstaller();
    return;
  }

  const v = localStorage.getItem(K_VER) || "unknown";
  verTag.textContent = "Installed: " + v;
  statusEl.textContent = "Booting EdgeOS…";
  setBar(100);

  // remove boot UI then mount OS
  document.getElementById("wrap").remove();

  const css = localStorage.getItem(K_CSS);
  const html = localStorage.getItem(K_HTML);
  const js = localStorage.getItem(K_JS);

  const style = document.createElement("style");
  style.textContent = css;
  document.head.appendChild(style);

  document.getElementById("app").innerHTML = html;

  const script = document.createElement("script");
  script.textContent = js;
  document.body.appendChild(script);
}

/* =========================
   INSTALL (ZIP) with FLATTEN + DEBUG
========================= */
async function installFromZip(){
  const file = document.getElementById("zipInput").files[0];
  debugBox.style.display = "none";
  debugList.textContent = "";

  if(!file){
    statusEl.textContent = "Please choose an EdgeOS update ZIP first.";
    return;
  }

  try{
    statusEl.textContent = "Reading ZIP package…";
    setBar(10);

    const zip = await JSZip.loadAsync(file);
    const names = Object.keys(zip.files);

    // DEBUG list
    debugBox.style.display = "block";
    debugList.textContent = names.join("\n");

    // find file at root or nested
    const findFile = (filename) => names.find(n => n === filename || n.endsWith("/" + filename));

    const htmlPath = findFile("app.html");
    const jsPath   = findFile("app.js");
    const cssPath  = findFile("style.css") || findFile("styles.css");

    if(!htmlPath || !jsPath || !cssPath){
      setBar(0);
      statusEl.textContent =
        "Invalid package: required files not found.\n" +
        "Need: app.html, app.js, style.css\n\n" +
        "Tip: Your ZIP can be foldered, but must contain these files somewhere inside.";
      return;
    }

    setBar(45);
    statusEl.textContent = "Extracting and installing…";

    localStorage.setItem(K_HTML, await zip.file(htmlPath).async("string"));
    localStorage.setItem(K_JS,   await zip.file(jsPath).async("string"));
    localStorage.setItem(K_CSS,  await zip.file(cssPath).async("string"));

    // If you want version to come from zip later, add manifest.json in future.
    localStorage.setItem(K_VER, "0.0.2");

    setBar(100);
    const foldered = (htmlPath.includes("/") || jsPath.includes("/") || cssPath.includes("/"));
    statusEl.textContent =
      "Install complete. " + (foldered ? "(Foldered ZIP auto-fixed)\n" : "\n") +
      "Rebooting to EdgeOS…";

    verTag.textContent = "Installed: " + (localStorage.getItem(K_VER) || "unknown");

    setTimeout(bootIfInstalled, 900);
  }catch(e){
    console.error(e);
    setBar(0);
    statusEl.textContent = "Install failed: ZIP could not be read.";
  }
}

/* =========================
   POWERWASH (INSTALLER LEVEL)
========================= */
function powerwashInstaller(){
  const ok = confirm("Powerwash will erase EdgeOS (apps, files, settings). Continue?");
  if(!ok) return;

  // Remove EdgeOS keys only
  const keys = Object.keys(localStorage);
  for(const k of keys){
    if(k.startsWith("edgeos_")) localStorage.removeItem(k);
  }

  debugBox.style.display = "none";
  debugList.textContent = "";
  verTag.textContent = "No system installed";
  setBar(0);
  statusEl.textContent = "Powerwash complete. Please install EdgeOS from ZIP.";
}

/* =========================
   INITIAL STARTUP
========================= */
(function init(){
  const v = localStorage.getItem(K_VER);
  verTag.textContent = v ? ("Installed: " + v) : "No system installed";

  if(hasInstalledOS()){
    statusEl.textContent = "EdgeOS found. Click Boot, or install an update ZIP.";
    setBar(0);
  } else {
    statusEl.textContent = "No EdgeOS installed. Please install from ZIP.";
    setBar(0);
  }
})();
</script>

</body>
</html>
